<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>差旅費用智慧計算器 (App版)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Lucide Setup -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .ios-safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* 彈出視窗動畫 */
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .animate-slide-up {
            animation: slideUp 0.3s ease-out forwards;
        }

        @media print {
            .no-print { display: none !important; }
            .print-break { page-break-inside: avoid; }
            body { background-color: white; }
            input, select { border: none !important; background: transparent !important; appearance: none; padding: 0; }
            input::placeholder { color: transparent; }
            #root { padding-bottom: 0 !important; }
        }
    </style>
</head>
<body class="font-sans text-slate-800">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Plane, Car, Home, Utensils, Gift, 
            User, Calculator, AlertCircle, 
            Printer, Save, ChevronUp, X, ChevronDown
        } from 'lucide-react';

        // --- 核心資料設定 ---
        const RANKS = [
            { id: 'staff', name: '一般員工 (1-15職等)', limit: '一般' },
            { id: 'manager', name: '主管 (經副理/16-19職等)', limit: '較高' },
            { id: 'exec', name: '高階主管 (董事長/總經理/副總)', limit: '實支' },
        ];

        const DOMESTIC_RATES = {
            staff: { breakfast: 80, meal: 200, lodgingLimit: 2000 },
            manager: { breakfast: 100, meal: 250, lodgingLimit: 2400 },
            exec: { breakfast: 120, meal: 300, lodgingLimit: 999999 },
        };

        const FOREIGN_RATES = {
            zoneA: { staff: 1600, manager: 1600, exec: 2000 },
            zoneB: { staff: 1300, manager: 1300, exec: 1700 },
        };

        const FOREIGN_ZONES = [
            { id: 'zoneA', name: 'A區 (日本/歐美/澳洲/香港)', desc: '高消費地區' },
            { id: 'zoneB', name: 'B區 (東南亞/韓國/大陸/其他)', desc: '一般地區' },
        ];

        // --- UI 元件 (移至外部以解決焦點遺失問題) ---
        const SectionTitle = ({ icon: Icon, title, color }) => (
            <div className={`flex items-center space-x-2 text-${color}-600 mb-4 border-b border-${color}-100 pb-2`}>
                <Icon className="w-5 h-5" />
                <h3 className="font-bold text-lg">{title}</h3>
            </div>
        );

        const InputGroup = ({ label, suffix, children }) => (
            <div className="mb-3">
                <label className="block text-sm font-medium text-slate-600 mb-1">{label}</label>
                <div className="relative">
                    {children}
                    {suffix && <span className="absolute right-3 top-2.5 text-slate-400 text-sm">{suffix}</span>}
                </div>
            </div>
        );

        const NumberInput = ({ name, placeholder, value, onChange }) => (
            <input 
                type="number" 
                name={name}
                value={value}
                onChange={onChange}
                placeholder={placeholder}
                className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none transition-all text-right font-mono text-lg"
                onFocus={(e) => e.target.select()}
            />
        );

        function TravelApp() {
            const [mode, setMode] = useState('domestic');
            const [showDetail, setShowDetail] = useState(false);

            // --- 表單資料 ---
            const [formData, setFormData] = useState({
                name: '',
                rank: 'staff',
                zone: 'zoneA',
                startDate: '',
                endDate: '',
                days: 1,
                nights: 0,
                publicCost: '',
                carKm: '',
                motoKm: '',
                fuelPrice: 31.0,
                lodgingCost: '',
                breakfastCount: '',
                lunchDinnerCount: '',
                hasEntertainment: false,
                entertainmentDays: '',
                telecomCost: '',
                entertainmentCost: '',
                drinksCost: '',
                giftCost: '',
                miscCost: '',
            });

            const [result, setResult] = useState({
                transportTotal: 0,
                lodgingTotal: 0,
                lodgingLimit: 0,
                lodgingOver: 0,
                mealAllowance: 0,
                mealDeduction: 0,
                finalMealTotal: 0,
                othersTotal: 0,
                grandTotal: 0,
            });

            // 自動計算天數
            useEffect(() => {
                if (formData.startDate && formData.endDate) {
                    const start = new Date(formData.startDate);
                    const end = new Date(formData.endDate);
                    const diffTime = end - start;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 
                    if (diffDays > 0) {
                        setFormData(prev => ({ 
                            ...prev, 
                            days: diffDays, 
                            nights: diffDays - 1 >= 0 ? diffDays - 1 : 0 
                        }));
                    }
                }
            }, [formData.startDate, formData.endDate]);

            // 核心計算邏輯
            useEffect(() => {
                let tTotal = 0, lTotal = 0, lLimit = 0, lOver = 0, mBase = 0, mDed = 0, oTotal = 0;

                // 1. 交通
                const pub = Number(formData.publicCost) || 0;
                const car = formData.carKm > 0 ? ((formData.carKm / 8) * formData.fuelPrice) + (formData.carKm * 2) : 0;
                const moto = formData.motoKm > 0 ? ((formData.motoKm / 20) * formData.fuelPrice) + (formData.motoKm * 1) : 0;
                tTotal = Math.round(pub + car + moto);

                // 2. 住宿
                const actualLodging = Number(formData.lodgingCost) || 0;
                if (mode === 'domestic') {
                    const rate = DOMESTIC_RATES[formData.rank].lodgingLimit;
                    lLimit = rate * formData.nights;
                    if (formData.rank !== 'exec' && actualLodging > lLimit) {
                        lTotal = actualLodging; 
                        lOver = actualLodging - lLimit;
                    } else {
                        lTotal = actualLodging;
                    }
                } else {
                    lTotal = actualLodging;
                    lLimit = 0;
                }

                // 3. 膳雜
                if (mode === 'domestic') {
                    const bRate = DOMESTIC_RATES[formData.rank].breakfast;
                    const ldRate = DOMESTIC_RATES[formData.rank].meal;
                    mBase = (Number(formData.breakfastCount) * bRate) + (Number(formData.lunchDinnerCount) * ldRate);
                } else {
                    const dailyRate = FOREIGN_RATES[formData.zone][formData.rank];
                    mBase = formData.days * dailyRate;
                    const entDays = Number(formData.entertainmentDays) || 0;
                    if (entDays > 0) mDed = Math.round(entDays * dailyRate * (1/3));
                }

                // 4. 其他
                oTotal = (Number(formData.telecomCost) || 0) +
                         (Number(formData.entertainmentCost) || 0) +
                         (Number(formData.drinksCost) || 0) +
                         (Number(formData.giftCost) || 0) +
                         (Number(formData.miscCost) || 0);

                setResult({
                    transportTotal: tTotal,
                    lodgingTotal: Math.round(lTotal),
                    lodgingLimit: lLimit,
                    lodgingOver: Math.round(lOver),
                    mealAllowance: Math.round(mBase),
                    mealDeduction: Math.round(mDed),
                    finalMealTotal: Math.round(mBase - mDed),
                    othersTotal: Math.round(oTotal),
                    grandTotal: Math.round(tTotal + lTotal + (mBase - mDed) + oTotal)
                });

            }, [formData, mode]);

            const handleInput = (e) => {
                const { name, value, type, checked } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: type === 'checkbox' ? checked : value
                }));
            };

            return (
                <div className="min-h-screen pb-32 md:pb-40 bg-gray-50">
                    
                    {/* Header */}
                    <header className="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-10 no-print">
                        <div className="max-w-2xl mx-auto flex justify-between items-center">
                            <div className="flex items-center space-x-2">
                                <Calculator className="w-5 h-5 text-blue-400" />
                                <h1 className="font-bold text-lg">差旅費用計算</h1>
                            </div>
                            <div className="bg-slate-800 rounded-full p-1 flex text-xs font-bold">
                                <button 
                                    onClick={() => setMode('domestic')}
                                    className={`px-3 py-1 rounded-full transition-all ${mode === 'domestic' ? 'bg-blue-500 text-white' : 'text-slate-400'}`}
                                >
                                    國內
                                </button>
                                <button 
                                    onClick={() => setMode('foreign')}
                                    className={`px-3 py-1 rounded-full transition-all ${mode === 'foreign' ? 'bg-indigo-500 text-white' : 'text-slate-400'}`}
                                >
                                    國外
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="max-w-2xl mx-auto p-4 space-y-4">
                        
                        {/* 1. 基本資料 */}
                        <section className="bg-white rounded-xl shadow-sm p-4 border border-slate-100">
                            <SectionTitle icon={User} title="基本資料" color="blue" />
                            <div className="grid grid-cols-2 gap-3">
                                <div className="col-span-2 md:col-span-1">
                                    <InputGroup label="姓名">
                                        <input 
                                            type="text" 
                                            name="name" 
                                            value={formData.name} 
                                            onChange={handleInput} 
                                            className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none" 
                                            placeholder="姓名" 
                                        />
                                    </InputGroup>
                                </div>
                                <div className="col-span-2 md:col-span-1">
                                    <InputGroup label="職級">
                                        <select 
                                            name="rank" 
                                            value={formData.rank} 
                                            onChange={handleInput} 
                                            className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
                                        >
                                            {RANKS.map(r => <option key={r.id} value={r.id}>{r.name}</option>)}
                                        </select>
                                    </InputGroup>
                                </div>
                                {mode === 'foreign' && (
                                    <div className="col-span-2">
                                        <InputGroup label="地區">
                                            <select 
                                                name="zone" 
                                                value={formData.zone} 
                                                onChange={handleInput} 
                                                className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
                                            >
                                                {FOREIGN_ZONES.map(z => <option key={z.id} value={z.id}>{z.name}</option>)}
                                            </select>
                                        </InputGroup>
                                    </div>
                                )}
                                <div className="col-span-2 grid grid-cols-2 gap-3">
                                    <InputGroup label="出發">
                                        <input 
                                            type="date" 
                                            name="startDate" 
                                            value={formData.startDate} 
                                            onChange={handleInput} 
                                            className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" 
                                        />
                                    </InputGroup>
                                    <InputGroup label="結束">
                                        <input 
                                            type="date" 
                                            name="endDate" 
                                            value={formData.endDate} 
                                            onChange={handleInput} 
                                            className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" 
                                        />
                                    </InputGroup>
                                </div>
                                <div className="col-span-2 text-center text-sm text-blue-600 bg-blue-50 py-1 rounded">
                                    共 <b>{formData.days}</b> 天 / <b>{formData.nights}</b> 晚
                                </div>
                            </div>
                        </section>

                        {/* 2. 交通 */}
                        <section className="bg-white rounded-xl shadow-sm p-4 border border-slate-100">
                            <SectionTitle icon={Plane} title="交通費用" color="emerald" />
                            <InputGroup label="大眾運輸/機票" suffix="元">
                                <NumberInput name="publicCost" value={formData.publicCost} onChange={handleInput} placeholder="0" />
                            </InputGroup>
                            {mode === 'domestic' && (
                                <div className="bg-emerald-50 p-3 rounded-lg border border-emerald-100 mt-2">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="text-sm font-bold text-emerald-800 flex items-center"><Car className="w-3 h-3 mr-1"/>私車公用 (含油資保養)</span>
                                        <span className="text-xs text-emerald-600">油價 ${formData.fuelPrice}</span>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <InputGroup label="汽車(km)"><NumberInput name="carKm" value={formData.carKm} onChange={handleInput} placeholder="0" /></InputGroup>
                                        <InputGroup label="機車(km)"><NumberInput name="motoKm" value={formData.motoKm} onChange={handleInput} placeholder="0" /></InputGroup>
                                    </div>
                                </div>
                            )}
                        </section>

                        {/* 3. 膳宿 */}
                        <section className="bg-white rounded-xl shadow-sm p-4 border border-slate-100">
                            <SectionTitle icon={Home} title="住宿與膳食" color="orange" />
                            <InputGroup label="住宿費 (實支總額)" suffix="元">
                                <NumberInput name="lodgingCost" value={formData.lodgingCost} onChange={handleInput} placeholder="0" />
                            </InputGroup>
                            {result.lodgingOver > 0 && <div className="text-xs text-red-500 mb-3 flex items-center"><AlertCircle className="w-3 h-3 mr-1"/>超支 {result.lodgingOver} 元</div>}
                            
                            <div className="h-px bg-slate-100 my-4"></div>

                            {mode === 'domestic' ? (
                                <div className="grid grid-cols-2 gap-3">
                                    <InputGroup label="早餐餐數" suffix="餐"><NumberInput name="breakfastCount" value={formData.breakfastCount} onChange={handleInput} placeholder="0" /></InputGroup>
                                    <InputGroup label="午/晚餐數" suffix="餐"><NumberInput name="lunchDinnerCount" value={formData.lunchDinnerCount} onChange={handleInput} placeholder="0" /></InputGroup>
                                </div>
                            ) : (
                                <div>
                                    <div className="flex justify-between text-sm mb-2">
                                        <span className="text-slate-600">國外日支費 (${FOREIGN_RATES[formData.zone][formData.rank]}/天)</span>
                                        <span className="font-bold text-orange-600">${result.mealAllowance}</span>
                                    </div>
                                    <div className="bg-red-50 p-3 rounded-lg border border-red-100">
                                        <label className="flex items-center space-x-2 mb-2">
                                            <input type="checkbox" checked={formData.hasEntertainment} onChange={(e) => setFormData(prev => ({...prev, hasEntertainment: e.target.checked}))} className="rounded text-red-500" />
                                            <span className="text-sm font-bold text-red-800">有交際應酬 (需扣抵)?</span>
                                        </label>
                                        {formData.hasEntertainment && (
                                            <div className="flex items-center gap-2">
                                                <span className="text-xs text-red-600 whitespace-nowrap">交際天數:</span>
                                                <input 
                                                    type="number" 
                                                    name="entertainmentDays" 
                                                    value={formData.entertainmentDays} 
                                                    onChange={handleInput} 
                                                    className="w-16 bg-white border border-red-200 rounded px-2 py-1 text-center outline-none focus:ring-2 focus:ring-red-200" 
                                                    placeholder="0" 
                                                />
                                                <span className="text-xs font-bold text-red-600 ml-auto">扣除 -${result.mealDeduction}</span>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </section>

                        {/* 4. 其他 */}
                        <section className="bg-white rounded-xl shadow-sm p-4 border border-slate-100">
                            <SectionTitle icon={Gift} title="其他雜支" color="purple" />
                            <div className="grid grid-cols-2 gap-3">
                                <InputGroup label="電信費"><NumberInput name="telecomCost" value={formData.telecomCost} onChange={handleInput} placeholder="0" /></InputGroup>
                                <InputGroup label="交際餐費"><NumberInput name="entertainmentCost" value={formData.entertainmentCost} onChange={handleInput} placeholder="0" /></InputGroup>
                                <InputGroup label="飲品/禮品"><NumberInput name="giftCost" value={formData.giftCost} onChange={handleInput} placeholder="0" /></InputGroup>
                                <InputGroup label="其他(過路費)"><NumberInput name="miscCost" value={formData.miscCost} onChange={handleInput} placeholder="0" /></InputGroup>
                            </div>
                        </section>
                    </main>

                    {/* --- 懸浮總計列 (Sticky Footer) --- */}
                    <div 
                        className="fixed bottom-0 left-0 right-0 bg-slate-900 text-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-50 transition-all duration-300 ios-safe-bottom no-print cursor-pointer"
                        onClick={() => setShowDetail(!showDetail)}
                    >
                        <div className="max-w-2xl mx-auto">
                            {/* 總金額顯示區 */}
                            <div className="p-4 flex justify-between items-center">
                                <div>
                                    <div className="text-xs text-slate-400 mb-0.5 flex items-center">
                                        預估請款總額
                                        {showDetail ? <ChevronDown className="w-3 h-3 ml-1" /> : <ChevronUp className="w-3 h-3 ml-1 animate-bounce" />}
                                    </div>
                                    <div className="text-3xl font-bold font-mono text-emerald-400 leading-none">
                                        ${result.grandTotal.toLocaleString()}
                                    </div>
                                </div>
                                <button className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg transition-colors">
                                    {showDetail ? '關閉明細' : '查看明細'}
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* --- 彈出式明細 (Slide-up Panel) --- */}
                    {showDetail && (
                        <div className="fixed inset-0 z-40 flex items-end justify-center no-print">
                            {/* 背景遮罩 */}
                            <div 
                                className="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity" 
                                onClick={() => setShowDetail(false)}
                            ></div>
                            
                            {/* 滑動面板 */}
                            <div className="relative w-full max-w-2xl bg-white rounded-t-2xl shadow-2xl animate-slide-up overflow-hidden mb-[80px]"> 
                                {/* Header */}
                                <div className="bg-slate-100 p-3 border-b border-slate-200 flex justify-between items-center">
                                    <h3 className="font-bold text-slate-700 flex items-center">
                                        <Calculator className="w-4 h-4 mr-2" /> 費用試算明細
                                    </h3>
                                    <button onClick={() => setShowDetail(false)} className="p-1 bg-slate-200 rounded-full hover:bg-slate-300">
                                        <X className="w-4 h-4" />
                                    </button>
                                </div>
                                
                                {/* Content */}
                                <div className="p-4 space-y-3 text-sm">
                                    <div className="flex justify-between py-1 border-b border-slate-100">
                                        <span className="text-slate-500">交通總額</span>
                                        <span className="font-mono font-bold">{result.transportTotal.toLocaleString()}</span>
                                    </div>
                                    <div className="flex justify-between py-1 border-b border-slate-100">
                                        <span className="text-slate-500">住宿總額</span>
                                        <span className="font-mono font-bold">{result.lodgingTotal.toLocaleString()}</span>
                                    </div>
                                    <div className="flex justify-between py-1 border-b border-slate-100">
                                        <span className="text-slate-500">膳雜費 (實領)</span>
                                        <span className="font-mono font-bold">{result.finalMealTotal.toLocaleString()}</span>
                                    </div>
                                    <div className="flex justify-between py-1 border-b border-slate-100">
                                        <span className="text-slate-500">其他雜支</span>
                                        <span className="font-mono font-bold">{result.othersTotal.toLocaleString()}</span>
                                    </div>
                                    
                                    <div className="pt-2 flex justify-between items-center">
                                        <span className="font-bold text-lg">總計</span>
                                        <span className="font-bold text-2xl text-emerald-600 font-mono">
                                            NT$ {result.grandTotal.toLocaleString()}
                                        </span>
                                    </div>

                                    <div className="grid grid-cols-2 gap-3 mt-4">
                                        <button 
                                            onClick={() => { window.print(); setShowDetail(false); }}
                                            className="flex items-center justify-center bg-slate-200 py-3 rounded-lg font-bold text-slate-700 hover:bg-slate-300"
                                        >
                                            <Printer className="w-4 h-4 mr-2" /> 列印
                                        </button>
                                        <button 
                                            onClick={() => { alert('請使用瀏覽器選單加入主畫面'); setShowDetail(false); }}
                                            className="flex items-center justify-center bg-blue-600 py-3 rounded-lg font-bold text-white hover:bg-blue-700"
                                        >
                                            <Save className="w-4 h-4 mr-2" /> 儲存
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<TravelApp />);
    </script>
</body>
</html>
